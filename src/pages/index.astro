---
// src/pages/index.astro
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

import GA from '../components/GoogleAnalytics.astro';

// 1. Fetch all food items to generate the category list dynamically
const allFoods = await getCollection('foods');

// 2. Use flatMap to get every category from every item's array
const categories = [...new Set(allFoods.flatMap((item) => item.data.category))].sort();

---

<html lang="en">
  <head>
    <GA id="G-EYN5ZFZK56" />

    <title>Is It Safe For My Dog?</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
  </head>
  <body class="bg-blue-50 min-h-screen font-sans flex flex-col">

    <!-- Main Container -->
    <main class="w-full max-w-2xl px-6 mt-20 text-center mx-auto">
      
      <!-- Title -->
      <h1 class="text-5xl font-extrabold text-blue-900 mb-2">
        Is It Safe For My Dog? üê∂
      </h1>
      <p class="text-gray-600 mb-10 text-xl">
        Instant safety guide for dog foods & household items.
      </p>

      <!-- Search Component -->
      <div class="relative w-full text-left">
        
        <!-- Input Field -->
        <input 
          type="text" 
          id="search-input" 
          placeholder="Search for a food (e.g. Grapes, Chocolate)..."
          class="w-full p-5 text-xl rounded-full shadow-lg border border-blue-200 focus:outline-none focus:ring-4 focus:ring-blue-300 transition"
        >

        <!-- Search Results Dropdown (Hidden by default) -->
        <ul 
          id="results-container" 
          class="hidden absolute top-full left-0 w-full bg-white shadow-xl rounded-xl mt-4 overflow-hidden z-10 border border-gray-100"
        >
          <!-- Results will be injected here by JavaScript -->
        </ul>
      </div>

      <!-- NEW: DYNAMIC Category Quick Links -->
      <div class="mt-12">
        <h2 class="text-gray-400 text-sm font-bold uppercase tracking-widest mb-4">Browse by Category</h2>
        <div class="flex flex-wrap justify-center gap-3">
            
            {/* We map over the dynamic 'categories' array instead of a hardcoded list */}
            {categories.map(cat => (
                <a 
                  href={`/category/${cat.toLowerCase().replace(/\s+/g, '-')}`} 
                  class="bg-white px-4 py-2 rounded-full text-blue-900 font-medium shadow-sm border border-blue-100 hover:bg-blue-600 hover:text-white hover:border-blue-600 transition"
                >
                    {cat}
                </a>
            ))}

        </div>
      </div>

    </main>

    <!-- The Search Logic Script -->
    <script>
      import Fuse from 'fuse.js';

      // 1. Fetch the data we generated
      let searchIndex = [];
      
      async function loadData() {
        try {
            const response = await fetch('/search.json');
            searchIndex = await response.json();
        } catch (e) {
            console.error("Could not load search index", e);
        }
      }
      
      loadData();

      // 2. Setup the search
      const searchInput = document.getElementById('search-input');
      const resultsContainer = document.getElementById('results-container');

      // Colors for the status badges
      const statusColors = {
        Safe: "bg-green-100 text-green-800",
        Caution: "bg-yellow-100 text-yellow-800",
        Toxic: "bg-red-100 text-red-800",
        Emergency: "bg-red-600 text-white"
      };

      // 3. Listen for typing
      if (searchInput && resultsContainer) {
          searchInput.addEventListener('input', (e) => {
            // @ts-ignore
            const query = e.target.value;
    
            // If empty, hide results
            if (query.length === 0) {
              resultsContainer.classList.add('hidden');
              return;
            }
    
            // Configure Fuse (Fuzzy search settings)
            const fuse = new Fuse(searchIndex, {
              // ADDED 'category' here so people can search for "Fruit" or "Meat"
              keys: ['name', 'keywords', 'category', 'description'], 
              threshold: 0.3, 
            });
    
            const results = fuse.search(query);
    
            // Render Results
            resultsContainer.innerHTML = '';
            
            if (results.length > 0) {
              resultsContainer.classList.remove('hidden');
              
              results.forEach((result) => {
                const item = result.item;
                
                // Create list item HTML
                const li = document.createElement('li');
                li.className = 'border-b last:border-0 hover:bg-gray-50 transition';
                li.innerHTML = `
                  <a href="/${item.slug}" class="block p-4">
                    <div class="flex justify-between items-center">
                      <span class="font-bold text-lg text-gray-800">${item.name}</span>
                      <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${statusColors[item.status]}">
                        ${item.status}
                      </span>
                    </div>
                    <p class="text-gray-500 text-sm mt-1 truncate">${item.description}</p>
                  </a>
                `;
                resultsContainer.appendChild(li);
              });
            } else {
                // No results found
                resultsContainer.classList.remove('hidden');
                resultsContainer.innerHTML = `
                    <li class="p-4 text-gray-500 text-center">
                        No results found for "${query}"
                    </li>
                `;
            }
          });
      }
    </script>
  <!-- ... existing script ... -->
    <Footer />
  </body>
</html>