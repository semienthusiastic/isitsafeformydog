---
import Footer from '../components/Footer.astro';
import { getCollection, render } from 'astro:content';
import SearchHeader from '../components/SearchHeader.astro';
import AdPlaceholder from '../components/AdPlaceholder.astro';

export async function getStaticPaths() {
  const foodEntries = await getCollection('foods');
  return foodEntries.map(entry => ({
    // FIX: Ensure we strip the extension here too, so the page exists at /coffee
    params: { slug: entry.id.replace(/\.md$/, '') }, 
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const statusColors = {
  Safe: "bg-green-100 text-green-800 border-green-200",
  Caution: "bg-yellow-100 text-yellow-800 border-yellow-200",
  Toxic: "bg-red-100 text-red-800 border-red-200",
  Emergency: "bg-red-600 text-white border-red-800 animate-pulse"
};

// 1. Pluralization Logic (Is vs Are)
const isPlural = entry.data.name.toLowerCase().endsWith('s'); 
const verb = isPlural ? "Are" : "Is";

// 2. Generate Share Links
const currentUrl = new URL(Astro.url.pathname, Astro.site);
const shareText = `${verb} ${entry.data.name} safe for dogs? Find out here:`;
const links = {
  facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl.href)}`,
  twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(currentUrl.href)}`,
  whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText + " " + currentUrl.href)}`,
  email: `mailto:?subject=${verb} ${entry.data.name} Safe for Dogs?&body=${encodeURIComponent(shareText + " " + currentUrl.href)}`
};
---

<html lang="en">
  <head>
    <!-- Basic SEO -->
    <title>{verb} {entry.data.name} Safe for Dogs? | Is It Safe?</title>
    <meta name="description" content={entry.data.description} />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
    <!-- Open Graph / Facebook / WhatsApp -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={`${verb} ${entry.data.name} Safe for Dogs?`} />
    <meta property="og:description" content={entry.data.description} />
    {entry.data.image && <meta property="og:image" content={new URL(entry.data.image, Astro.site)} />}
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:title" content={`${verb} ${entry.data.name} Safe for Dogs?`} />
    <meta property="twitter:description" content={entry.data.description} />
    {entry.data.image && <meta property="twitter:image" content={new URL(entry.data.image, Astro.site)} />}
  </head>
  <body class="bg-gray-50 min-h-screen font-sans flex flex-col">
    
    <SearchHeader />
    
    <main class="max-w-2xl mx-auto p-6 bg-white shadow-lg mt-6 rounded-lg mb-20">
      
      <!-- Header Section -->
      <div class="border-b pb-6 mb-6">
        <a href="/" class="text-blue-500 hover:underline text-sm">&larr; Back to Search</a>
        
        {entry.data.image && (
          <img 
            src={entry.data.image} 
            alt={entry.data.name} 
            class="w-full h-64 object-cover rounded-xl mt-4 shadow-md"
          />
        )}

        <!-- NEW: Loop through categories to display multiple links -->
            <div class="flex flex-wrap gap-2">
              {entry.data.category.map(cat => (
                <a 
                  href={`/category/${cat.toLowerCase().replace(/\s+/g, '-')}`} 
                  class="text-xs font-bold uppercase tracking-wider bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-blue-100 hover:text-blue-600 transition-colors"
                >
                    {cat}
                </a>
              ))}
            </div>

        <h1 class="text-4xl font-bold mt-6 text-gray-900">{entry.data.name}</h1>
        
        <div class={`inline-block mt-4 px-4 py-2 rounded-full font-bold border ${statusColors[entry.data.status]}`}>
          {entry.data.status.toUpperCase()}
        </div>

        <p class="text-gray-600 mt-4 text-lg italic">{entry.data.description}</p>

        <!-- Social Share Buttons -->
        <div class="flex items-center gap-3 mt-8 pt-6 border-t border-gray-100">
           <span class="text-xs text-gray-400 font-bold uppercase tracking-wider mr-1">Share this guide:</span>
           
           <!-- Facebook -->
           <a 
             href={links.facebook} 
             target="_blank" 
             rel="noopener noreferrer" 
             aria-label="Share on Facebook"
             class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-blue-600 hover:text-white transition-all duration-300"
           >
             <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
           </a>

           <!-- X (Twitter) -->
           <a 
             href={links.twitter} 
             target="_blank" 
             rel="noopener noreferrer" 
             aria-label="Share on X"
             class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-black hover:text-white transition-all duration-300"
           >
             <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
           </a>

           <!-- WhatsApp -->
           <a 
             href={links.whatsapp} 
             target="_blank" 
             rel="noopener noreferrer" 
             aria-label="Share on WhatsApp"
             class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-green-500 hover:text-white transition-all duration-300"
           >
             <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.463 1.065 2.876 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
           </a>

           <!-- Email -->
           <a 
             href={links.email} 
             aria-label="Share via Email"
             class="w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 text-gray-500 hover:bg-gray-600 hover:text-white transition-all duration-300"
           >
             <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24"><path d="M0 3v18h24v-18h-24zm6.623 7.929l-4.623 5.712v-11.174l4.623 5.462zm12.008 9.071h-13.262l5.347-6.606 1.284 1.517 1.284-1.517 5.347 6.606zm-1.254-14.53l-5.377 6.353-5.377-6.353h10.754zm.623 11.174l-4.623-5.712 4.623-5.462v11.174z"/></svg>
           </a>
        </div>
      </div> 

      <!-- Article Content -->
      <article class="prose prose-lg text-gray-800 prose-headings:text-blue-900">
        <AdPlaceholder />
        <Content />
      </article>

      <!-- NEW: Source Citation Block -->
      {entry.data.source && (
        <div class="bg-gray-50 border-l-4 border-gray-300 p-4 mt-8 rounded-r-md">
          <p class="text-sm text-gray-600 mb-1 font-bold uppercase tracking-wider">
            Source Reference
          </p>
          <p class="text-sm text-gray-700">
            Data sourced from: 
            {entry.data.sourceUrl ? (
              <a 
                href={entry.data.sourceUrl} 
                target="_blank" 
                rel="noopener noreferrer nofollow" 
                class="text-blue-600 hover:underline font-medium"
              >
                {entry.data.source} &rarr;
              </a>
            ) : (
              <span class="font-medium">{entry.data.source}</span>
            )}
          </p>
        </div>
      )}

    </main>

  <Footer />
  </body>
</html>